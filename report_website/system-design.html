<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design - Companio</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>



  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="index.html">Companio</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="index.html" id="homeDropdown" role="button" data-bs-toggle="dropdown">Home</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="index.html#abstract">Abstract</a></li>
                        <li><a class="dropdown-item" href="index.html#Video">Video</a></li>
                            <li><a class="dropdown-item" href="index.html#Team Members">Team Members</a></li>
                            <li><a class="dropdown-item" href="index.html#Project Timeline">Project Timeline</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="requirementsDropdown" role="button" data-bs-toggle="dropdown">Requirements</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="requirements.html#project-background">Project Background</a></li>
                        <li><a class="dropdown-item" href="requirements.html#client-requirements">Client Requirements</a></li>
                        <li><a class="dropdown-item" href="requirements.html#project-goal">Project Goal</a></li>
                        <li><a class="dropdown-item" href="requirements.html#user-interviews">User Interviews</a></li>
                        <li><a class="dropdown-item" href="requirements.html#personas">Personas</a></li>
                        <li><a class="dropdown-item" href="requirements.html#Use Cases">Use Cases</a></li>
                        <li><a class="dropdown-item" href="requirements.html#moscow">MoSCoW List</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="research.html" id="researchDropdown" role="button" data-bs-toggle="dropdown">Research</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="research.html#stakeholder-insights">Stakeholder Insights</a></li>
                        <li><a class="dropdown-item" href="research.html#Technology Research & Selection">Technology Research & Selection</a></li>
                        <li><a class="dropdown-item" href="research.html#RAG Algorithm">RAG Algorithm</a></li>
                        <li><a class="dropdown-item" href="research.html#Memory Games">Memory Games</a></li>
                        <li><a class="dropdown-item" href="research.html#Existing Solution Evaluation">Existing Solution Evaluation</a></li>
                        <li><a class="dropdown-item" href="research.html#Design Decisions Informed by Research">Design Decisions Informed by Research</a></li>
                    </ul>
                </li>
              
                <li class="nav-item"><a class="nav-link" href="ui-design.html">UI Design</a></li>
    


                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="system-design.html" id="designDropdown" role="button" data-bs-toggle="dropdown">System Design</a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="system-design.html#System Architecture">System Architecture</a></li>
                      <li><a class="dropdown-item" href="system-design.html#Sequence Diagram">Sequence Diagram</a></li>
                      <li><a class="dropdown-item" href="system-design.html#Design Patterns">Design Patterns</a></li>
                      <li><a class="dropdown-item" href="system-design.html#Data Storage">Data Storage</a></li>
                    </ul>
                  </li>

                  

                <li class="nav-item"><a class="nav-link" href="implementation.html">Implementation</a></li>



                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="testing.html" id="testingDropdown" role="button" data-bs-toggle="dropdown">Testing</a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="testing.html#testing-strategy">Testing Strategy</a></li>
                      <li><a class="dropdown-item" href="testing.html#unit-testing">Unit Testing</a></li>
                      <li><a class="dropdown-item" href="testing.html#integration-testing">Integration Testing</a></li>
                      <li><a class="dropdown-item" href="testing.html#uat">User Acceptance Testing</a></li>

                    </ul>
                  </li>


                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="evaluation.html" id="evaluationDropdown" role="button" data-bs-toggle="dropdown">
                      Evaluation
                    </a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="evaluation.html#moscow-achievement">MoSCoW Achievement Table</a></li>
                      <li><a class="dropdown-item" href="evaluation.html#known-bugs">List of Known Bugs</a></li>
                      <li><a class="dropdown-item" href="evaluation.html#individual-contribution">Individual Contribution</a></li>
                      <li><a class="dropdown-item" href="evaluation.html#critical-evaluation">Critical Evaluation</a></li>
                      <li><a class="dropdown-item" href="evaluation.html#future-work">Future Work</a></li>
                    </ul>
                  </li>
                  
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="appendicesDropdown" role="button" data-bs-toggle="dropdown">Appendices</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="appendices.html#monthly-videos">Monthly Videos</a></li>
                        <li><a class="dropdown-item" href="appendices.html#Bi-Weekly Blogs">Bi-Weekly Blogs</a></li>
                        <li><a class="dropdown-item" href="appendices.html#user-manual">User Manual</a></li>
                        <li><a class="dropdown-item" href="appendices.html#development-manual">Development Manual</a></li>
                        <li><a class="dropdown-item" href="appendices.html#privacy">Privacy of Data</a></li>
                    </ul>
                </li>
            </ul>
                <!-- Github Link -->
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                      <a class="nav-link" href="https://github.com/HJH-08/Group25" target="_blank" title="GitHub Repository">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.7-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                          </svg>
                      </a>
                  </li>
              </ul>
        </div>
    </div>
</nav>


    <!-- Page content -->
    <div class="container mt-5 pt-5">
            <!-- System Design Section -->
            
                <h1 class="text-center"> System design</h1>


                <section id="system-design" class="section"></section>

                <section id="System Architecture" class="section">
                    <h2>System Architecture</h2>
                <p>
                    The system is designed to provide both online and offline AI companionship, integrating various components to ensure seamless interaction and efficient memory retention.
                    The frontend is built using JavaScript and leverages the Three.js library to render customizable 3D avatars for an engaging user experience. Additionally, the system includes memory-enhancing games implemented in the frontend to improve cognitive function and retention.
                    At the core is the Semantic Kernel, a lightweight hub that manages AI integration, user interactions, memory retrieval, and model orchestration. The backend communicates with the frontend via FAST APIs, triggered on every request.
                    AI speech is used in both modes for voice input and text-to-speech conversion.
                  </p>

                     <h3>Online Mode</h3>
                  <div class="text-center mb-3">
                    <img src="images/SA1.jpg" class="img-fluid" alt="Online system architecture">
                  </div>
                  <p>
                    In online mode, the web application connects to the Semantic Kernel, which manages long-term memory by retrieving stored conversation history from Azure AI Search Service. Each request is associated with a unique user ID, allowing the system to query the correct search index for personalized responses. After retrieving relevant past interactions and documentation, the Semantic Kernel forwards the processed request to the GPT API, which is hosted online. This ensures that responses are context-aware and personalized, overcoming the typical memory limitations of AI models. Additionally, Azure Speech Services provides text-to-speech capabilities, allowing users to engage with the chatbot using voice.
                  </p>
                
                    <h3>Offline Mode</h3>
                  <div class="text-center mb-3">
                    <img src="images/SA2.jpg" class="img-fluid" alt="Offline system architecture">
                  </div>
                  <p>
                    In offline mode, the web application remains the primary interface but processes all interactions locally. The Semantic Kernel retrieves and processes user inputs using a Qdrant Vector Database, which powers a hybrid RAG (Retrieval-Augmented Generation) system by embedding and recalling past conversations. The response is then generated by IBM Granite or Microsoft Phi-3.5, lightweight, state-of-the-art AI models chosen for their efficiency in running on local devices without excessive computational demand. After processing, if the user opts for text-to-speech output, the system utilizes Coqui AI TTS, a lightweight, open-source text-to-speech engine. This setup provides a privacy-focused AI alternative while maintaining meaningful conversation history, ensuring that users have a functional AI companion without reliance on the cloud.

                  </p>
                </section>
            


                <section id="Sequence Diagram" class="section">
                    <h2>Sequence Diagram</h2>
                
                <h4>Online</h4>
                <div class="text-center mt-3 mb-5">
                    <img src="images/seOn.jpg" alt="Online Sequence Diagram" class="img-fluid">
                    </div>

                    <p>When a user interacts with the chatbot, they either type a message or speak, triggering AI speech-to-text conversion before sending a POST request to /api/chat. The system retrieves relevant past interactions from Azure AI Search Service using a GET request, identified by a unique user ID linked to stored vectorized memory data (ElderlyUserMemory). The retrieved memory, along with the new input, is forwarded via a POST request to the GPT API, which processes the request and returns a response. This response is displayed in the frontend, and if speech output is enabled, the chatbot sends a POST request to /api/text-to-speech. The text is then converted into speech using Azure Speech Services, which synthesizes speech into an audio file. The system reads the generated audio bytes and returns them to the browser, where they are played for the user. Finally, the user inputs are embedded and stored in Azure AI Search Service, ensuring that relevant information is available for future interactions.
                    </p>


                <h4>Offline</h4>
                <div class="text-center mt-3">
                    <img src="images/seOff.jpg" alt="Offline Sequence Diagram" class="img-fluid">
                  </div>

                  <p>
                    In offline mode, the chatbot processes user input through the web application, which communicates with the Semantic Kernel via FastAPI endpoints. If speech input is used, it is first converted into text using AI Speech. The web application sends a POST request to /api/chat. The Semantic Kernel then attempts to retrieve relevant past interactions stored locally in Qdrant, a vector database optimized for hybrid Retrieval-Augmented Generation (RAG). The system uses dense embeddings, sparse BM25 embeddings, and late interaction embeddings, enhancing retrieval accuracy by ranking relevant past conversations. If relevant memory exists, the Semantic Kernel appends it to the query and forwards the request to the selected AI model—either IBM Granite or Microsoft Phi-3.5—via a POST request to /api/generate-response, where the AI processes the input and returns a chatbot response. New memory is stored when the system performs an upsert operation to insert it into Qdrant. The web application then displays the response in the UI, and if text-to-speech (TTS) is enabled, a POST request is sent to /api/text-to-speech, where Coqui AI TTS synthesizes the text into speech audio bytes. The web application then plays the generated audio, completing the interaction loop. If Qdrant is unavailable, the system logs an error, skips contextual retrieval, and proceeds with only the AI model's response.
                  </p>
                </section>
            
                <section id="Design Patterns" class="section">
                <h2>Design Patterns</h2>
                <p>
                    In developing <strong>Companio</strong>, several essential design patterns were applied to ensure the system remains modular, extensible, and maintainable.
                  </p>
                  <ol>
                    <li>
                      <strong>Facade Pattern</strong>, embodied by the Semantic Kernel. Acting as a central orchestrator, it hides the complexities of backend operations?such as long-term memory retrieval, chatbot logic, and text-to-speech conversion. The frontend and APIs only need to specify configuration options, while the Semantic Kernel handles all underlying logic, making interaction seamless for the user.
                    </li>
                    <li>
                      The <strong>Strategy Pattern</strong> is evident in the way different configurations-like choosing between GPT, Granite, or Phi-3.5, or different TTS engines?are handled. Despite varied implementations, they follow a consistent interface, allowing the system to easily swap or upgrade components without rewriting major logic.
                    </li>
                    <li>
                      The <strong>Observer Pattern</strong> underpins the frontend, with React and Three.js responding dynamically to user input via well-managed state, enabling real-time updates in avatar rendering and chatbot responses.
                    </li>
                    <li>
                      We employed the <strong>Singleton Pattern</strong> for shared services like the Qdrant client, embedding models, and the Semantic Kernel itself. These are initialized once and reused, improving performance and resource management.
                    </li>
                    <li>
                      The <strong>Adapter Pattern</strong> bridges differences between APIs and services?ensuring all functions, regardless of provider, conform to common input and output structures. This simplifies integration and ensures future flexibility.
                    </li>
                  </ol>
                  <p>
                    Core <strong>design principles</strong> were followed closely. Each module adheres to the <strong>Single Responsibility Principle</strong>, with separate logic for memory storage, LLM interactions, and audio processing. The <strong>Don't Repeat Yourself (DRY) Principle</strong> was respected through shared utilities and configuration files, reducing redundancy. Code smells—like long functions, tight coupling, or "God objects"—were consciously avoided, especially through multiple refactorings of backend logic.
                  </p>
                </section>
                </section>
            
                <section id="Data Storage" class="section">
                <h2>Data Storage</h2>
                <p>
                    In our project, we do not use a traditional relational database or formalized entity-relationship (ER) schema. Instead, we opted for a more flexible and modern vector-based storage approach to support context-aware information retrieval. At the core of our data layer lies a simple yet effective <strong>Pydantic model</strong>. This model defines how user-generated conversational memories are structured before being embedded and stored for retrieval.
                  </p>
                  <ul>
                    <li>A unique ID</li>
                    <li>A text field (<code>memory_text</code>)</li>
                    <li>A category (such as “question“ or “preference“)</li>
                    <li>A timestamp</li>
                  </ul>
                  <p>
                    The memory text is vectorized using OpenAI's embedding model into a 1536-dimensional vector, which is then stored as part of the record. This schema provides enough structure to organize conversations meaningfully, while being optimized for use in vector similarity search systems.
                  </p>
                
                  <h4>Online Mode</h4>
                  <p>
                    In online mode, this structured memory is stored in <strong>Azure AI Search</strong>, which supports both full-text and vector-based retrieval. Each memory is upserted into a collection tied to a specific user ID, allowing our <strong>Retrieval-Augmented Generation (RAG)</strong> system to personalize results per individual.
                  </p>
                  <p>
                    Embeddings are generated at runtime using a vectorizer service and attached to the record before storage. At retrieval time, both keyword search and semantic vector search are run in parallel, and the results are merged using a <strong>Rank Reciprocal Fusion (RRF)</strong> algorithm to ensure the most contextually relevant responses are used to ground the chatbot's reply. This setup supports efficient long-term memory retention in a scalable and cloud-ready manner.
                  </p>
                
                  <h4>Offline Mode</h4>
                  <p>
                    In offline mode, we use <strong>Qdrant</strong>, a local vector database hosted via Docker, as our main retrieval engine. The same <code>ElderlyUserMemory</code> structure is converted into a <code>PointStruct</code>, where multiple types of embeddings are stored: dense vectors, BM25 sparse vectors, and late interaction embeddings. These are all generated using separate embedding models locally loaded into the Semantic Kernel.
                  </p>
                  <p>
                    We use hybrid retrieval techniques and rerank results by relevance before feeding them into the chatbot. This approach allows us to maintain personalized memory functionality while operating in a completely disconnected environment.
                  </p>
                
                  <p>
                    Overall, our use of vector databases, hybrid RAG, and well-defined embedding schemas enables <strong>Companio</strong> to maintain long-term memory with low overhead and high adaptability, both online and offline.
                  </p>
            </section>
  



        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/scripts.js"></script>
<!-- Footer -->
<footer class="bg-dark text-white mt-5 py-4">
  <div class="container">
      <div class="row">
          <!-- Copyright information -->
          <div class="col-md-6">
              <h5 class="mb-2 text-white-50">Companio</h5>
              <p class="mb-2 text-white-50">© 2025. All rights reserved.</p>
              <p class="small">Developed by Group 25 - UCL Computer Science</p>
          </div>
          
          <!-- Footer navigation -->
          <div class="col-md-6">
              <ul class="nav justify-content-end">
                  <li class="nav-item">
                      <a class="nav-link text-white" href="https://github.com/HJH-08/Group25" target="_blank">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.7-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                          </svg>
                          GitHub
                      </a>
                  </li>
              </ul>
          </div>
      </div>
  </div>
</footer>    
</body>
</html>


